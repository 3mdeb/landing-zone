stages:
  - build

build_debug_disabled:
  stage: build
  image: gcc:9.3.0
  # install bsdmainutils for hexdump
  before_script:
    - apt update && apt -y install bsdmainutils
  script:
    - make
  artifacts:
    paths:
      - lz_header.bin

build_debug_enabled:
  stage: build
  image: gcc:9.3.0
  # install bsdmainutils for hexdump
  before_script:
    - apt update && apt -y install bsdmainutils
  script:
    - make DEBUG=y
  artifacts:
    paths:
      - lz_header.bin

build_nixpkg_debug_disabled:
  stage: build
  image: nixos/nix:2.3
  before_script:
    - nix-env -i git
    - nix-env -iA cachix -f https://cachix.org/api/v1/install
  script:
    - git clone https://github.com/3mdeb/nixos-trenchboot-configs.git
    - GIT_DESCRIBE=$(git describe HEAD --tags)
    - sed -e "s/0.3.0+git/${GIT_DESCRIBE:1}/" -i nixos-trenchboot-configs/nixpkgs/landing-zone/default.nix
    - NIX_STORE_PATH=$(nix-build nixos-trenchboot-configs/nixpkgs/landing-zone/default.nix)
    - nix-store --export $NIX_STORE_PATH | bzip2 > landing-zone.closure.bz2
  artifacts:
    paths:
      - landing-zone.closure.bz2

build_nixpkg_debug_enabled:
  stage: build
  image: nixos/nix:2.3
  before_script:
    - nix-env -i git
    - nix-env -iA cachix -f https://cachix.org/api/v1/install
  script:
    - git clone https://github.com/3mdeb/nixos-trenchboot-configs.git
    - GIT_DESCRIBE=$(git describe HEAD --tags)
    - sed -e "s/0.3.0+git/${GIT_DESCRIBE:1}/" -i nixos-trenchboot-configs/nixpkgs/landing-zone-debug/default.nix
    - NIX_STORE_PATH=$(nix-build nixos-trenchboot-configs/nixpkgs/landing-zone-debug/default.nix)
    - nix-store --export $NIX_STORE_PATH | bzip2 > landing-zone-debug.closure.bz2
  artifacts:
    paths:
      - landing-zone-debug.closure.bz2

build_nixpkg_debug_disabled_cachix:
  stage: build
  only:
    tags
  image: nixos/nix:2.3
  before_script:
    - nix-env -i git
    - nix-env -iA cachix -f https://cachix.org/api/v1/install
  script:
    - git clone https://github.com/3mdeb/nixos-trenchboot-configs.git
    - NIX_STORE_PATH=$(nix-build nixos-trenchboot-configs/nixpkgs/landing-zone/default.nix)
    - cachix authtoken $CACHIX_AUTHTOKEN
    - cachix push 3mdeb $NIX_STORE_PATH

build_nixpkg_debug_enabled_cachix:
  stage: build
  only:
    tags
  image: nixos/nix:2.3
  before_script:
    - nix-env -i git
    - nix-env -iA cachix -f https://cachix.org/api/v1/install
  script:
    - git clone https://github.com/3mdeb/nixos-trenchboot-configs.git
    - NIX_STORE_PATH=$(nix-build nixos-trenchboot-configs/nixpkgs/landing-zone-debug/default.nix)
    - cachix authtoken $CACHIX_AUTHTOKEN
    - cachix push 3mdeb $NIX_STORE_PATH
